{% extends 'shop/base.html' %}
{% load static %}
{% block title %}Tienda{% endblock %}

{% block content %}

		<div class="untree_co-section before-footer-section">
            <div class="container">
              <div class="row mb-5">
                <form class="col-md-12">
                  <div class="site-blocks-table">
                    <table class="table">
                      <thead>
                        <tr>
                          <th class="product-thumbnail">Imagen</th>
                          <th class="product-name">Producto</th>
                          <th class="product-price">Precio</th>
                          <th class="product-quantity">Cantidad</th>
                          <th class="product-total">Total</th>
                          <th class="product-remove">Eliminar</th>
                        </tr>
                      </thead>
                      <tbody id="carrito-body">

                        
                      </tbody>
                    </table>
                  </div>
                </form>
              </div>
        
              <div class="row">
                <div class="col-md-6">
                  <div class="row mb-5">
                    <div class="col-md-6 mb-3 mb-md-0">
                      <button onclick="actualizarTotales()" class="btn btn-black btn-sm btn-block">Actualizar Carrito</button>
                    </div>
                    <div class="col-md-6">
                      <a href="{% url 'shop' 1 %}"><button class="btn btn-outline-black btn-sm btn-block">Seguir Comprando</button></a>
                    </div>
                  </div>
                 
                </div>

                <div class="col-md-6 pl-5">
                  <div class="row justify-content-end">
                    <div class="col-md-7">
                      <div class="row">
                        <div class="col-md-12 text-right border-bottom mb-5">
                          <h3 class="text-black h4 text-uppercase">Totales de Compra</h3>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <span class="text-black">Subtotal</span>
                        </div>
                        <div class="col-md-6 text-right">
                          <strong class="text-black" id="subtotal">$0.00</strong>
                        </div>
                      </div>
                      <div class="row mb-5">
                        <div class="col-md-6">
                          <span class="text-black">Total</span>
                        </div>
                        <div class="col-md-6 text-right">
                          <strong class="text-black" id="total">$0.00</strong>
                        </div>
                      </div>
        
                      <div class="row">
                        <div class="col-md-12">
                          <button id="btn" data-authenticated="{{ user_authenticated|yesno:"true,false" }}" class="btn btn-black btn-lg py-3 btn-block">Proceder al Pago</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
		  <script src="{% static 'shop/js/cart.js' %}"></script>
      <script>
        document.getElementById("btn").addEventListener("click", async function () {
            const isUserAuthenticated = {{ user_authenticated|yesno:"true,false" }};
            if (!isUserAuthenticated) {
                window.location.href = "{% url 'login' %}";
                return;
            }
        
            let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        
            const response = await fetch("{% url 'sale' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                  username : userID, 
                  productos: carrito 
                })
            });
        
            const result = await response.json();
        
            if (result.login_required) {
                window.location.href = "{% url 'login' %}";
                return;
            }
            
            if (result.data.productos_insuficientes != undefined) {
              if (result.data.productos_insuficientes.length > 0){
                let productosQuitados = [];
        
                // Filtrar carrito y obtener nombres de productos quitados
                carrito = carrito.filter(producto => {
                    if (result.data.productos_insuficientes.includes(producto.id)) {
                        productosQuitados.push(producto.nombre);
                        return false; // no lo incluye
                    }
                    return true; // lo mantiene
                });
        
                localStorage.setItem("carrito", JSON.stringify(carrito));
        
                Swal.fire({
                    icon: 'error',
                    title: 'Stock insuficiente',
                    html: `<p>Los siguientes productos no tienen suficiente stock:</p><ul style="text-align: left;">${productosQuitados.map(p => `<li>${p}</li>`).join("")}</ul>`,
                    confirmButtonText: 'Aceptar'
                }).then(() => {
                    // Recargar carrito para reflejar los cambios
                    window.location.href = "{% url 'cart' %}";
                });
              }
            } else {
                Swal.fire({
                    icon: 'success',
                    title: '¡Todo listo!',
                    text: 'Todos los productos tienen suficiente stock. Puedes continuar con la compra.',
                    confirmButtonText: 'Aceptar'
                });
                // Aquí podrías redirigir a /checkout si lo deseas
                // window.location.href = "{% url 'checkout' %}";
            }
        });
        </script>        

{% endblock %}